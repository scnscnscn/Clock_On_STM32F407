/********************************************************************************
 * @file    delay.c
 * @brief   STM32F4xx系统延时函数实现
 * @author  项目开发团队
 * @date    2025-12-27
 * @version 2.0
 * 
 * @description
 * 本文件实现了基于SysTick定时器的精确延时功能，包括：
 * 1. 毫秒级延时函数 (delay_ms)
 * 2. 微秒级延时函数 (delay_us)
 * 3. SysTick定时器初始化和管理
 * 
 * @note
 * - SysTick配置为1ms中断一次
 * - delay_ms使用中断计数实现，精度高
 * - delay_us使用软件循环实现，精度相对较低
 * - 系统时钟频率: 168MHz
 ********************************************************************************/

#include "stm32f4xx.h"
#include "delay.h"

/********************************************************************************
 * @brief 全局延时计数器
 * @note  在SysTick中断中递减，用于实现非阻塞延时
 ********************************************************************************/
unsigned int TimingDelay = 0;

/********************************************************************************
 * @brief   系统滴答定时器初始化
 * @param   无
 * @retval  无
 * @note    配置SysTick产生1ms周期中断
 *          计算方法: 168MHz / 1000 = 168000 (每1ms触发一次中断)
 ********************************************************************************/
void SysTick_Init(void)
{
    /* 配置SysTick定时器，周期为1ms */
    if (SysTick_Config(SystemCoreClock / 1000))
    {
        /* 配置失败，进入死循环 */
        while (1);
    }
}

/********************************************************************************
 * @brief   毫秒级延时函数
 * @param   time 延时时间（单位：毫秒）
 * @retval  无
 * @note    此函数使用SysTick中断计数实现精确延时
 *          延时过程中CPU可以响应中断
 *          最大延时时间: 2^32 ms = 49.7天
 ********************************************************************************/
void delay_ms(unsigned int time)
{
    TimingDelay = time;  /* 设置延时计数初值 */
    
    /* 等待TimingDelay在中断中递减至0 */
    while(TimingDelay);
}

/********************************************************************************
 * @brief   微秒级延时函数（近似）
 * @param   time 延时时间（单位：微秒）
 * @retval  无
 * @note    此函数使用软件循环实现延时，精度受编译优化影响
 *          在168MHz主频下，每次循环约0.125us
 *          适用于短时间精确延时（<1ms）
 *          不建议用于长时间延时（会占用CPU）
 ********************************************************************************/
void delay_us(unsigned int time)
{  
   unsigned short i=0; 
    
   while(time--)
   {
      i = 8;  /* 根据主频调整此值，168MHz约需8次循环达到1us */
      while(i--) ;    
   }
}

/********************************************************************************
 * @brief   延时计数器递减函数
 * @param   无
 * @retval  无
 * @note    此函数在SysTick_Handler中断服务程序中被调用
 *          每1ms调用一次，用于实现delay_ms的计时功能
 ********************************************************************************/
void TimingDelay_Decrement(void)
{
    if (TimingDelay != 0x00)
    {
        TimingDelay--;  /* 延时计数器非零时递减 */
    }
}
