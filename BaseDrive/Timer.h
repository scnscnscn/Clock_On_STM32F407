#ifndef __TIMER_H
#define __TIMER_H

/********************************************************************************
 * @file    TIMER.h
 * @brief   基于TIM10的多闹钟定时器管理头文件
 * @author  开发者名称
 * @date    2025-12-23
 * @version V1.0
 * @note    1. 定时器基础时间片为10ms，基于TIM10中断实现；
 *          2. 采用优先级队列管理多闹钟，剩余时间越短优先级越高；
 *          3. 支持单次/重复闹钟，最大支持9个并发闹钟（可通过MAX_ALARM_NUM调整）；
 *          4. 所有队列操作建议添加临界区保护，避免中断与主循环数据竞争。
 ********************************************************************************/
#include "stm32f4xx.h"
#include <stdint.h>
#include <stddef.h> 

/********************************************************************************
 * @brief   闹钟重复模式枚举
 * @note    ALARM_ONCE为单次触发（触发后自动删除），ALARM_REPEAT为重复触发（触发后重置时间）
 ********************************************************************************/
typedef enum {
    ALARM_ONCE = 0, // 单次闹钟：触发后失效
    ALARM_REPEAT    // 重复闹钟：触发后重置剩余时间（自动赋值为1）
} AlarmMode;

/********************************************************************************
 * @brief   闹钟状态枚举（内部使用）
 * @note    用于标记队列中闹钟节点的有效性，避免空节点误操作
 ********************************************************************************/
typedef enum {
    ALARM_INVALID = 0, // 无效状态：节点未被使用
    ALARM_VALID        // 有效状态：节点已注册闹钟
} AlarmState;

/********************************************************************************
 * @brief   闹钟回调函数类型定义
 * @note    回调函数需遵循「无返回值、无参数」规则，由定时器中断触发执行
 ********************************************************************************/
typedef void (*AlarmCallback)(void);

/********************************************************************************
 * @brief   闹钟节点结构体（优先级队列元素）
 * @note    按remain_time升序排列，实现最短时间闹钟优先处理
 ********************************************************************************/
typedef struct {
    uint32_t remain_time; // 剩余时间（单位：时间片，即10ms）
    uint32_t duration;    // 定时总时长（单位：时间片）
    AlarmMode mode;       // 闹钟重复模式
    AlarmState state;     // 闹钟有效状态
    AlarmCallback cb;     // 闹钟触发回调函数
    uint8_t id;           // 闹钟唯一ID（1~MAX_ALARM_NUM）
} AlarmNode_T;

/********************************************************************************
 * @defgroup 定时器配置宏
 * @brief    可根据项目需求调整的核心参数
 * @{
 ********************************************************************************/
#define MAX_ALARM_NUM 9  // 最大支持的闹钟数量（默认9个）
#define TIME_SLICE_MS 1 // 基础时间片长度（单位：ms），与TIM10中断周期一致
/** @} */

/********************************************************************************
 * @brief   全局变量声明（实际定义在TIMER.c中）
 * @note    供中断文件（it.c）和定时器核心文件访问队列数据
 ********************************************************************************/
extern AlarmNode_T alarm_queue[MAX_ALARM_NUM]; // 闹钟优先级队列
extern uint8_t queue_size;                     // 当前有效闹钟数量
extern uint8_t next_id;                        // 下一个待分配的闹钟ID

/********************************************************************************
 * @defgroup 公共函数声明
 * @brief    外部可调用的定时器与闹钟管理接口
 ********************************************************************************/
void TIM10_TimeSliceInit(void);                                            // TIM10初始化：生成10ms基础时间片中断
void AlarmManager_Init(void);                                              // 闹钟管理器初始化：清空队列、重置ID
void AlarmTimer_Process(void);                                             // 闹钟核心处理逻辑：供中断函数调用

#endif /* __TIMER_H */