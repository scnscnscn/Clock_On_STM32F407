# STM32F407智能时钟与天气显示系统 - 技术文档

## 项目概述

本项目是一个基于STM32F407微控制器的智能时钟系统，具备实时时钟显示、天气信息展示、多闹钟管理和触摸屏交互等功能。

### 主要功能特性

1. **实时时钟显示**: 显示当前时间（时:分:秒）和日期
2. **天气信息展示**: 温度、湿度、降水量、天气图标
3. **多闹钟管理**: 支持4个独立可配置闹钟
4. **触摸屏交互**: 双页面切换，可视化操作
5. **串口通信**: USART3接收天气数据

### 硬件配置

- **MCU**: STM32F407ZGT6 (168MHz, 192KB RAM, 1MB Flash)
- **显示**: 480x800 TFT LCD with capacitive touch
- **通信**: USART3 (115200bps)
- **定时器**: TIM10 (10ms时间片)
- **指示**: LED (PF0-7), 蜂鸣器 (PC13)

## 系统架构

### 软件架构图



### 模块说明

#### 1. User/ - 用户代码
- **main.c**: 主程序，包含核心业务逻辑
- **stm32f4xx_it.c**: 中断服务程序
- **kokomi.h**: 背景图片数据
- **weather_icons.h**: 天气图标数据

#### 2. BaseDrive/ - 基础驱动
- **Timer.c/h**: TIM10定时器和闹钟队列管理
- **USART.c/h**: 串口通信实现
- **DEVICE.c/h**: LED和蜂鸣器GPIO控制
- **KEY.c/h**: 按键驱动
- **EXIT.c/h**: 外部中断配置
- **delay.c/h**: 延时函数

#### 3. ExternalDrive/ - 外部设备驱动
- **LCD/**: LCD显示驱动和字库
- **TOUCH/**: 多种触摸芯片驱动

## 核心功能实现

### 1. 时间管理

系统使用TIM10产生10ms时间片，通过软件计数器实现秒级时间更新：



### 2. 闹钟系统

支持两类闹钟：
- **系统闹钟**: 用于定时任务（如天气更新），通过Timer模块管理
- **用户闹钟**: 可视化配置的提醒闹钟（共4个）



### 3. 天气数据

通过串口接收天气数据，格式为：



### 4. 触摸交互

支持双页面切换和触摸按钮操作：
- **PAGE_1**: 主界面（天气+闹钟列表）
- **PAGE_2**: 闹钟设置界面



## 数据流程

### 主循环任务调度



### 天气数据流程



### 触摸处理流程



## 性能指标

| 指标 | 数值 | 说明 |
|------|------|------|
| RAM使用 | <4KB | 主要用于缓冲区 |
| Flash使用 | ~970KB | 包含图片和字库 |
| 触摸响应 | <100ms | 包含防抖时间 |
| 页面切换 | ~300ms | 全屏刷新耗时 |
| 天气更新 | <1s | 串口接收+解析+显示 |

## 开发指南

### 编译环境
- **IDE**: Keil MDK-ARM V5.x 或 STM32CubeIDE
- **编译器**: ARM Compiler V5/V6 或 GCC
- **调试器**: ST-Link V2/V3

### 编译步骤
1. 打开工程文件 Clock.uvprojx
2. 选择目标芯片 STM32F407ZGT6
3. 配置优化级别 -O2
4. 编译生成 .hex/.bin 文件
5. 使用ST-Link烧录到目标板

### 调试技巧
1. **串口调试**: 通过USART3输出调试信息
2. **LED指示**: 使用LED指示程序执行状态
3. **断点调试**: 在关键函数设置断点

## 常见问题

### LCD无显示
- 检查LCD电源和FSMC引脚配置
- 确认背光控制引脚状态
- 读取LCD控制器ID验证通信

### 触摸无响应
- 检查I2C通信（SCL/SDA）
- 确认触摸芯片I2C地址
- 运行触摸屏校准程序

### 串口无数据
- 验证波特率（115200）
- 确认TX/RX引脚连接
- 使用串口工具测试

### 时间不准确
- 调整时间累加阈值
- 使用外部RTC芯片
- 通过串口同步网络时间

## 扩展建议

1. **功能扩展**
   - 增加农历显示
   - 接入实时天气API
   - 添加语音播报
   - 支持多语言

2. **硬件升级**
   - 更换高分辨率屏幕
   - 增加SD卡存储
   - 添加蓝牙/WiFi模块
   - 接入GPS模块

3. **软件优化**
   - 移植RTOS（FreeRTOS）
   - 实现低功耗模式
   - 数据持久化存储

## 附录

### 引脚定义表

| 外设 | 引脚 | 功能 |
|------|------|------|
| LED1-8 | PF0-7 | 状态指示 |
| 蜂鸣器 | PC13 | 闹钟提示 |
| 按键 | PF8 | 外部中断 |
| USART3_TX | PB10 | 串口发送 |
| USART3_RX | PB11 | 串口接收 |

### 中断优先级

| 中断源 | 抢占优先级 | 说明 |
|--------|-----------|------|
| TIM10 | 1 | 定时器（最高）|
| USART3 | 2 | 串口接收 |
| EXTI8 | 2 | 按键中断 |
| SysTick | 3 | 系统滴答 |

## 参考资料

1. STM32F407数据手册
2. STM32F4xx参考手册
3. 和风天气API文档
4. FT5206触摸芯片手册

## 开源协议

本项目采用 MIT License 开源协议。

---

**文档版本**: 2.0  
**最后更新**: 2025-12-27  
**维护者**: 项目开发团队
